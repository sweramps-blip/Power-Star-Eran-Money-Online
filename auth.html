<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Power Star | Secure Auth</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* آپ کا اصل ڈیزائن - 100% وہی */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; font-family: 'Outfit', sans-serif; background: #0a0e1a; color: #fff; -webkit-font-smoothing: antialiased; overflow-x: hidden; }
body::before { content: ''; position: fixed; top: -40%; left: 50%; transform: translateX(-50%); width: 600px; height: 600px; background: radial-gradient(circle, rgba(251,191,36,0.12) 0%, transparent 70%); pointer-events: none; z-index: 0; }
.page { min-height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px 16px; position: relative; z-index: 1; }
.logo-wrap { text-align: center; margin-bottom: 28px; }
.logo-icon { width: 64px; height: 64px; background: linear-gradient(135deg, #fbbf24, #f59e0b); border-radius: 18px; display: inline-flex; align-items: center; justify-content: center; font-size: 28px; color: #0a0e1a; box-shadow: 0 6px 24px rgba(251,191,36,0.35); margin-bottom: 14px; }
.logo-wrap h1 { font-size: 24px; font-weight: 800; color: #fff; letter-spacing: 1.5px; text-transform: uppercase; }
.logo-wrap p { font-size: 12px; color: #64748b; margin-top: 3px; letter-spacing: 0.5px; }
.card { width: 100%; max-width: 380px; background: #131829; border: 1px solid #1e2a45; border-radius: 24px; padding: 28px 22px 24px; position: relative; box-shadow: 0 12px 48px rgba(0,0,0,0.35); }
.tab-bar { display: flex; background: #0a0e1a; border-radius: 14px; padding: 4px; margin-bottom: 28px; gap: 4px; }
.tab-btn { flex: 1; padding: 10px 0; border: none; background: transparent; color: #64748b; font-size: 14px; font-weight: 600; border-radius: 11px; cursor: pointer; transition: all 0.3s ease; }
.tab-btn.active { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #0a0e1a; box-shadow: 0 3px 12px rgba(251,191,36,0.3); }
.form-panel { display: none; animation: fadeUp 0.35s ease; }
.form-panel.active { display: block; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.field { position: relative; margin-bottom: 16px; }
.field label { display: block; font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 7px; padding-left: 2px; }
.input-wrap input { width: 100%; padding: 13px 14px 13px 42px; background: #0f1423; border: 1.5px solid #1e2a45; border-radius: 13px; color: #fff; font-family: 'Outfit', sans-serif; font-size: 14px; outline: none; transition: 0.25s; }
.input-wrap input:focus { border-color: #fbbf24; box-shadow: 0 0 0 3px rgba(251,191,36,0.15); }
.input-icon { position: absolute; left: 13px; top: 50%; transform: translateY(-50%); color: #3d4f6e; font-size: 14px; pointer-events: none; }
.eye-toggle { position: absolute; right: 13px; top: 50%; transform: translateY(-50%); color: #3d4f6e; font-size: 14px; cursor: pointer; background: none; border: none; z-index: 2; }
.phone-prefix { position: absolute; left: 38px; top: 50%; transform: translateY(-50%); font-size: 13px; font-weight: 600; color: #fbbf24; pointer-events: none; }
.input-wrap.phone input { padding-left: 78px; }
.strength-track { display: flex; gap: 5px; margin-top: 8px; height: 3px; }
.strength-seg { flex: 1; border-radius: 3px; background: #1e2a45; transition: 0.3s; }
.strength-seg.on-weak { background: #ef4444; }
.strength-seg.on-medium { background: #f97316; }
.strength-seg.on-strong { background: #22c55e; }
.strength-label { font-size: 11px; margin-top: 5px; font-weight: 600; min-height: 16px; }
.terms-row { display: flex; align-items: flex-start; gap: 10px; margin: 20px 0; cursor: pointer; }
.terms-row input { accent-color: #fbbf24; width: 16px; height: 16px; margin-top: 2px; }
.terms-row span { font-size: 12px; color: #64748b; line-height: 1.4; }
.submit-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #fbbf24, #f59e0b); border: none; border-radius: 13px; color: #0a0e1a; font-size: 15px; font-weight: 700; cursor: pointer; transition: 0.25s; box-shadow: 0 4px 16px rgba(251,191,36,0.3); }
.submit-btn:active { transform: scale(0.96); }
.device-row { margin-top: 22px; text-align: center; font-size: 11px; color: #3d4f6e; display: flex; align-items: center; justify-content: center; gap: 6px; }
.did-value { color: #64748b; font-weight: 600; }
</style>
</head>
<body>

<div class="page">
  <div class="logo-wrap">
    <div class="logo-icon"><i class="fas fa-bolt"></i></div>
    <h1>Power Star</h1>
    <p>Secure Authentication</p>
  </div>

  <div class="card">
    <div class="tab-bar">
      <button class="tab-btn active" id="tab-login" onclick="switchTab('login')">Login</button>
      <button class="tab-btn" id="tab-register" onclick="switchTab('register')">Register</button>
    </div>

    <div class="form-panel active" id="panel-login">
      <div class="field"><label>Phone Number</label><div class="input-wrap phone"><i class="fas fa-phone input-icon"></i><span class="phone-prefix">+92</span><input type="tel" id="l-num" placeholder="3001234567"></div></div>
      <div class="field"><label>Password</label><div class="input-wrap"><i class="fas fa-lock input-icon"></i><input type="password" id="l-pass" placeholder="Enter password"><button class="eye-toggle" onclick="toggleEye('l-pass', this)"><i class="fas fa-eye"></i></button></div></div>
      <button class="submit-btn" onclick="doLogin()">Login</button>
    </div>

    <div class="form-panel" id="panel-register">
      <div class="field"><label>Full Name</label><div class="input-wrap"><i class="fas fa-user input-icon"></i><input type="text" id="r-name" placeholder="Full name"></div></div>
      <div class="field"><label>Phone Number</label><div class="input-wrap phone"><i class="fas fa-phone input-icon"></i><span class="phone-prefix">+92</span><input type="tel" id="r-num" placeholder="3001234567"></div></div>
      <div class="field">
        <label>Password</label>
        <div class="input-wrap"><i class="fas fa-lock input-icon"></i><input type="password" id="r-pass" placeholder="Create password" oninput="checkStrength()"><button class="eye-toggle" onclick="toggleEye('r-pass', this)"><i class="fas fa-eye"></i></button></div>
        <div class="strength-track"><div class="strength-seg" id="seg1"></div><div class="strength-seg" id="seg2"></div><div class="strength-seg" id="seg3"></div></div>
        <div class="strength-label" id="strength-label"></div>
      </div>
      <div class="field"><label>Referral Code</label><div class="input-wrap"><i class="fas fa-tag input-icon"></i><input type="text" id="r-ref" placeholder="Optional"></div></div>
      <label class="terms-row"><input type="checkbox" id="terms-chk"><span>I agree to <b>Terms & Conditions</b></span></label>
      <button class="submit-btn" onclick="doRegister()">Create Account</button>
    </div>
    <div class="device-row">ID: <span class="did-value" id="did-text">######</span></div>
  </div>
</div>
<script>
const API = "https://script.google.com/macros/s/AKfycbzX--o3MoKrZ3ZWNsVoWzfiadhtk3jtrK4abVes_yRAkkZTFWdjz44JoUYB-qpWNT0X/exec";
const KEY = "POWER_STAR_786_SECURE";

// ✅ 1. AUTOMATIC REFERRAL CAPTURE (New Logic added without disturbing old)
window.addEventListener('load', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const refFromUrl = urlParams.get('ref');
    if (refFromUrl) {
        const refField = document.getElementById("r-ref");
        if (refField) {
            refField.value = refFromUrl;
            refField.readOnly = true; // لاک کر دیا تاکہ غلطی سے مٹ نہ جائے
            refField.style.background = "rgba(251, 191, 36, 0.1)"; // ہلکا سا ہائی لائٹ
        }
    }
});

// 1. Device ID Logic (UNTOUCHED)
function getUniqueDeviceId() {
    let id = localStorage.getItem('ps_unique_device_id');
    if (!id) {
        id = 'PS-' + Math.random().toString(36).substring(2, 10) + Date.now().toString(36).slice(-4);
        localStorage.setItem('ps_unique_device_id', id);
    }
    return id;
}
const current_device_id = getUniqueDeviceId();
document.getElementById("did-text").innerText = current_device_id.slice(0, 8).toUpperCase();

// 2. UI Helpers (UNTOUCHED)
function switchTab(t){
  document.getElementById("tab-login").classList.toggle("active",t==='login');
  document.getElementById("tab-register").classList.toggle("active",t==='register');
  document.getElementById("panel-login").classList.toggle("active",t==='login');
  document.getElementById("panel-register").classList.toggle("active",t==='register');
}
function toggleEye(id, btn) {
  const el = document.getElementById(id);
  el.type = el.type === "password" ? "text" : "password";
}
function checkStrength() {
  const p = document.getElementById("r-pass").value;
  const segs = [document.getElementById("seg1"), document.getElementById("seg2"), document.getElementById("seg3")];
  const label = document.getElementById("strength-label");
  segs.forEach(s => s.className = "strength-seg");
  if (!p) { label.innerText = ""; return; }
  if (p.length < 6) { segs[0].classList.add("on-weak"); label.innerText = "Weak"; label.style.color = "#ef4444"; }
  else if (p.length < 10) { segs[0].classList.add("on-medium"); segs[1].classList.add("on-medium"); label.innerText = "Medium"; label.style.color = "#f97316"; }
  else { segs.forEach(s => s.classList.add("on-strong")); label.innerText = "Strong"; label.style.color = "#22c55e"; }
}

// 3. LOGIN (UNTOUCHED)
async function doLogin() {
    const num = document.getElementById('l-num').value.trim();
    const pass = document.getElementById('l-pass').value.trim();
    if(!num || !pass) return Swal.fire("Error", "Fill all fields", "error");

    Swal.fire({ title: 'Logging in...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

    try {
        const res = await fetch(API);
        const data = await res.json();
        const users = data.users || [];
        const user = users.find(u => String(u.number) === num && String(u.password) === pass);

        if(!user) return Swal.fire("Error", "Ghalt Number ya Password!", "error");

        localStorage.setItem("ps_user", JSON.stringify(user));
        Swal.fire("Success", "Welcome Back!", "success").then(() => { window.location.href = "dashboard.html"; });
    } catch(e) { Swal.fire("Error", "Connection Failed", "error"); }
}

// 4. REGISTER (UNTOUCHED LOGIC - JUST ADDED SYNC)
async function doRegister() {
  const name = document.getElementById("r-name").value.trim();
  const num = document.getElementById("r-num").value.trim();
  const pass = document.getElementById("r-pass").value.trim();
  const ref = document.getElementById("r-ref").value.trim() || "DIRECT";
  const terms = document.getElementById("terms-chk").checked;

  if(!name || !num || !pass) return Swal.fire("Warning", "Saray fields bharain", "warning");
  if(!terms) return Swal.fire("Terms", "Accept T&C", "info");

  Swal.fire({title: 'Checking...', didOpen: () => Swal.showLoading()});

  try {
    const res = await fetch(API);
    const data = await res.json();
    const users = data.users || [];

    if(users.some(u => String(u.number) === num)) return Swal.fire("Error", "Number already registered", "error");
    if(users.some(u => u.device_id === current_device_id)) return Swal.fire("Error", "1 Mobile = 1 Account Only!", "error");

    const auto_id = "PS" + String(users.length + 1).padStart(4, '0');
    const payload = { key: KEY, action: "register", name: name, number: num, password: pass, referral: ref, device_id: current_device_id, date: new Date().toLocaleDateString(), user_id: auto_id };

    await fetch(API, { method: "POST", body: JSON.stringify(payload) });
    Swal.fire("Success", "Account Created!", "success").then(() => { switchTab('login'); });
  } catch(e) { Swal.fire("Error", "Failed", "error"); }
}
</script>

</body>
</html>
