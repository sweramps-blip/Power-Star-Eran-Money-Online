<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Power Star | Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { 
            --gold: #fbbf24; --gold-dark: #d97706; --bg: #0a0e1a; 
            --card: #1a1f35; --border: #2d3548; --card-dark: #151929;
            --text-secondary: #94a3b8;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #fff; margin: 0; padding-bottom: 100px; overflow-x: hidden; }
        .header { padding: 20px; background: #131829; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .user-meta { display: flex; align-items: center; justify-content: space-between; padding: 10px 20px; background: #0f1423; font-size: 12px; border-bottom: 1px solid var(--border); }
        .id-badge { background: rgba(251, 191, 36, 0.1); color: var(--gold); padding: 4px 10px; border-radius: 8px; border: 1px solid rgba(251, 191, 36, 0.3); font-weight: 700; }
        .balance-card { background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%); padding: 30px 25px; border-radius: 24px; margin: 20px; box-shadow: 0 15px 35px rgba(217, 119, 6, 0.2); text-align: center; position: relative; }
        .history-icon { position: absolute; right: 20px; top: 20px; color: #fff; background: rgba(0,0,0,0.15); padding: 10px; border-radius: 50%; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .income-btn { background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3); color: #0a0e1a; padding: 10px 20px; border-radius: 12px; font-weight: 700; font-size: 13px; cursor: pointer; margin-top: 15px; display: inline-block; }
        .history-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.85); z-index: 9999; align-items: center; justify-content: center; padding: 20px; }
        .history-modal.show { display: flex; }
        .history-content { background: var(--card); border-radius: 20px; border: 1px solid var(--border); max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto; position: relative; }
        .history-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--card); z-index: 1; }
        .history-header h3 { font-size: 18px; font-weight: 800; color: var(--gold); }
        .close-modal { background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; color: #ef4444; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; }
        .history-body { padding: 15px 20px; }
        .history-item { background: var(--card-dark); padding: 14px; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .history-type { font-size: 14px; font-weight: 700; color: #fff; }
        .history-amount { font-size: 16px; font-weight: 900; color: var(--gold); }
        .news-box { margin: 0 20px 25px; background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); padding: 10px; border-radius: 12px; display: flex; align-items: center; }
        .news-box marquee { font-size: 13px; font-weight: 600; color: #fff; }
        .media-container { margin: 0 20px; background: var(--card); border-radius: 24px; padding: 12px; border: 1px solid var(--border); }
        .media-content { width: 100%; height: 220px; background: #000; border-radius: 16px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .media-content img, .media-content video { width: 100%; height: 100%; object-fit: cover; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: #131829; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid var(--border); z-index: 1000; }
        .nav-link { color: var(--text-secondary); text-decoration: none; font-size: 10px; text-align: center; }
        .nav-link i { font-size: 20px; display: block; margin-bottom: 4px; }
        .nav-link.active { color: var(--gold); }
    </style>
</head>
<body>

    <div class="header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="font-weight:800; font-size: 20px; margin:0;">POWER <span style="color:var(--gold)">STAR</span></h2>
            <div style="display: flex; gap: 15px; align-items: center;">
                <i class="fa-solid fa-headset" style="color: var(--gold); font-size: 18px;"></i>
                <i class="fa-solid fa-right-from-bracket" onclick="logout()" style="color: #ef4444; font-size: 18px; cursor:pointer;"></i>
            </div>
        </div>
    </div>

    <div class="user-meta">
        <span id="u-name" style="font-weight: 600; color: var(--text-secondary);">Loading...</span>
        <span class="id-badge" id="u-id">PS####</span>
    </div>

    <div class="balance-card">
        <div class="history-icon" onclick="openHistory()">
            <i class="fa-solid fa-clock-rotate-left"></i>
        </div>
        <p style="font-size:13px; font-weight:600; opacity:0.8; margin-bottom:5px;">Available Balance</p>
        <h1 style="font-size:35px; font-weight:900; margin:0;">Rs. <span id="u-bal">0.00</span></h1>
        <div class="income-btn" onclick="showIncome()">
            <i class="fa-solid fa-sack-dollar"></i> View Income
        </div>
    </div>

    <div class="news-box">
        <span style="background:var(--gold); color:#000; padding:3px 8px; border-radius:6px; font-size:10px; font-weight:800; margin-right:10px;">NEWS</span>
        <marquee id="news-text">Syncing with server...</marquee>
    </div>

    <div class="media-container">
        <div class="media-content" id="media-content">
            <i class="fa-solid fa-circle-notch fa-spin" style="font-size:40px; color:var(--gold); opacity:0.5;"></i>
        </div>
    </div>

    <nav class="nav-bar">
        <a href="dashboard.html" class="nav-link active"><i class="fa-solid fa-house"></i>Home</a>
        <a href="https://sweramps-blip.github.io/Markeeting-/" class="nav-link"><i class="fa-solid fa-chart-simple"></i>Marketing</a>
        <a href="team.html" class="nav-link"><i class="fa-solid fa-users-viewfinder"></i>Team</a>
        <a href="wallet.html" class="nav-link"><i class="fa-solid fa-wallet"></i>Wallet</a>
    </nav>

    <div class="history-modal" id="history-modal">
        <div class="history-content">
            <div class="history-header">
                <h3><i class="fa-solid fa-history"></i> Transaction History</h3>
                <button class="close-modal" onclick="closeHistory()">CLOSE</button>
            </div>
            <div class="history-body" id="history-body">
                <p style="text-align: center; color: #64748b; padding: 30px;">Loading...</p>
            </div>
        </div>
    </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzX--o3MoKrZ3ZWNsVoWzfiadhtk3jtrK4abVes_yRAkkZTFWdjz44JoUYB-qpWNT0X/exec";

async function syncDashboard() {
    const localUser = JSON.parse(localStorage.getItem("ps_user"));
    if (!localUser) { window.location.href = "index.html"; return; }
    
    document.getElementById("u-name").innerText = localUser.name || "User";

    try {
        const res = await fetch(API_URL);
        const data = await res.json();
        
        if (data.users) {
            const dbUser = data.users.find(u => String(u.number) === String(localUser.number));
            if(dbUser) {
                document.getElementById("u-bal").innerText = parseFloat(dbUser.balance).toFixed(2);
                document.getElementById("u-id").innerText = dbUser.user_id;
                document.getElementById("u-name").innerText = dbUser.name;
                localStorage.setItem("ps_user", JSON.stringify(dbUser));
            }
        }

        if (data.settings && data.settings.news) {
            const newsMarquee = document.getElementById("news-text");
            if(newsMarquee) newsMarquee.innerHTML = data.settings.news;
        }

        const mediaBox = document.getElementById("media-content");
        if (mediaBox && data.settings && data.settings.media_link) {
            const type = data.settings.media_type;
            const link = data.settings.media_link;

            if (type === "video") {
                let fileId = "";
                if (link.includes("/d/")) {
                    fileId = link.split("/d/")[1].split("/")[0];
                } else if (link.includes("id=")) {
                    fileId = link.split("id=")[1].split("&")[0];
                }

                let finalLink = fileId ? `https://drive.google.com/uc?export=download&id=${fileId}` : link;
                
                mediaBox.innerHTML = `
                    <video autoplay muted loop playsinline 
                           style="width:100%; height:100%; object-fit:cover; border-radius:16px;"
                           onerror="this.parentElement.innerHTML='<p style=color:red;font-size:10px;>Video Error</p>'">
                        <source src="${finalLink}" type="video/mp4">
                        <source src="${link}" type="video/webm">
                    </video>`;
            } else {
                mediaBox.innerHTML = `<img src="${link}" style="width:100%; height:100%; object-fit:cover;">`;
            }
        }
    } catch (e) {
        console.log("Sync Error: ", e);
    }
}

async function openHistory() {
    document.getElementById("history-modal").classList.add("show");
    const localUser = JSON.parse(localStorage.getItem("ps_user"));
    const historyBody = document.getElementById("history-body");

    try {
        const res = await fetch(API_URL);
        const data = await res.json();
        const userHistory = data.withdrawals.filter(w => String(w.user_id) === String(localUser.user_id));

        let html = '';
        userHistory.reverse().forEach(item => {
            let displayTitle = "Withdrawal (" + item.status + ")";
            html += `
                <div class="history-item">
                    <div class="history-item-left">
                        <div class="history-type">${displayTitle}</div>
                        <div class="history-date">${new Date(item.date).toLocaleDateString()}</div>
                    </div>
                    <div class="history-amount">Rs. ${parseFloat(item.amount).toFixed(2)}</div>
                </div>`;
        });
        historyBody.innerHTML = html || '<p style="text-align:center; padding:20px;">No history.</p>';
    } catch (e) { historyBody.innerHTML = '<p>Error loading...</p>'; }
}

function closeHistory() { document.getElementById("history-modal").classList.remove("show"); }

function showIncome() {
    const user = JSON.parse(localStorage.getItem("ps_user"));
    Swal.fire({
        title: '<strong>ðŸ’° Your Income</strong>',
        html: `<div style="text-align: left; padding: 10px;">
                <p><b>Total Balance:</b> Rs. ${parseFloat(user.balance).toFixed(2)}</p>
                <p><b>User ID:</b> ${user.user_id}</p>
               </div>`,
        icon: 'info',
        confirmButtonColor: '#fbbf24'
    });
}

function logout() {
    localStorage.removeItem("ps_user");
    window.location.href = "index.html";
}

document.addEventListener('DOMContentLoaded', syncDashboard);
</script>
</body>
</html>
